<form id="stencilForm" class="row g-3">

  <!-- ROW 1 -->
  <div class="col-md-2">
    <label class="form-label">FG</label>
    <input name="fg" class="form-control uc" required>
  </div>
  <div class="col-md-2">
    <label class="form-label">SIDE</label>
    <input name="side" class="form-control uc" required>
  </div>
  <div class="col-md-3">
    <label class="form-label">CUSTOMER</label>
    <input name="customer" class="form-control uc" required>
  </div>
  <div class="col-md-3">
    <label class="form-label">STENCIL NO</label>
    <input name="stencil_no" class="form-control uc" required>
  </div>
  <div class="col-md-2">
    <label class="form-label">RACK NO</label>
    <input name="rack_no" class="form-control uc">
  </div>
  <div class="col-md-2">
    <label class="form-label">LOCATION</label>
    <input name="location" class="form-control uc">
  </div>

  <!-- ROW 2 -->
  <div class="col-md-2">
    <label class="form-label">STENCIL MILS</label>
    <input name="stencil_mils" class="form-control uc">
  </div>
  <div class="col-md-2">
    <label class="form-label">STENCIL MILS-USL</label>
    <input name="stencil_mils_usl" class="form-control uc" readonly>
  </div>
  <div class="col-md-2">
    <label class="form-label">STENCIL MILS-LSL</label>
    <input name="stencil_mils_lsl" class="form-control uc" readonly>
  </div>

  <!-- ROW 3 -->
  <div class="col-md-3">
    <label class="form-label">STENCIL SUPPLIER</label>
    <input name="stencil_supplier" class="form-control uc">
  </div>
  <div class="col-md-3">
    <label class="form-label">STENCIL PR.NO</label>
    <input name="stencil_pr_no" class="form-control uc">
  </div>

  <!-- ROW 4 -->
  <div class="col-md-3">
    <label class="form-label">DATE RECEIVED</label>
    <input type="date" name="date_received" class="form-control">
  </div>
  <div class="col-md-3">
    <label class="form-label">STENCIL VALIDATION DT</label>
    <input type="date" name="stencil_validation_dt" class="form-control">
  </div>
  <div class="col-md-3">
    <label class="form-label">STENCIL RE-VALIDATION DT</label>
    <input type="date" name="stencil_revalidation_dt" class="form-control">
  </div>

  <!-- ROW 5 -->
  <div class="col-md-2"><label class="form-label">TENSION A</label><input name="tension_a" class="form-control uc"></div>
  <div class="col-md-2"><label class="form-label">TENSION B</label><input name="tension_b" class="form-control uc"></div>
  <div class="col-md-2"><label class="form-label">TENSION C</label><input name="tension_c" class="form-control uc"></div>
  <div class="col-md-2"><label class="form-label">TENSION D</label><input name="tension_d" class="form-control uc"></div>
  <div class="col-md-2"><label class="form-label">TENSION E</label><input name="tension_e" class="form-control uc"></div>

  <!-- ROW 6 -->
  <div class="col-md-4">
    <label class="form-label">RECEIVED BY</label>
    <input name="received_by" class="form-control uc">
  </div>
</form>

<script>
// Auto-fill from stencil_mils
document.querySelector('[name="stencil_mils"]').addEventListener('input', e => {
  const val = e.target.value.trim();
  if (!val) return;
  const uslEl = document.querySelector('[name="stencil_mils_usl"]');
  const lslEl = document.querySelector('[name="stencil_mils_lsl"]');

  if (val.includes('/')) {
    // Handle fraction style (e.g., "5/8")
    const parts = val.split('/');
    if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
      uslEl.value = `${Number(parts[0]) + 2}/${Number(parts[1]) + 2}`;
      lslEl.value = `${Number(parts[0]) - 1}/${Number(parts[1]) - 1}`;
    }
  } else if (!isNaN(val)) {
    uslEl.value = Number(val) + 2;
    lslEl.value = Number(val) - 1;
  }
});

// Auto-set revalidation date = +1 year
document.querySelector('[name="stencil_validation_dt"]').addEventListener('change', e => {
  const dt = new Date(e.target.value);
  if (!isNaN(dt)) {
    dt.setFullYear(dt.getFullYear() + 1);
    document.querySelector('[name="stencil_revalidation_dt"]').value = dt.toISOString().slice(0,10);
  }
});

// Fetch existing data when STENCIL NO + SIDE are filled
async function tryFetchStencilData() {
  const stencilNo = document.querySelector('[name="stencil_no"]').value.trim().toUpperCase();
  const side = document.querySelector('[name="side"]').value.trim().toUpperCase();
  if (!stencilNo || !side) return;

  const res = await fetch(`/api/received`);
  const list = await res.json();
  const match = list.find(r => r.stencil_no === stencilNo && r.side === side);
  if (match) {
    // Fill fields except FG and Customer
    const fields = ["rack_no","location","stencil_mils","stencil_mils_usl","stencil_mils_lsl",
      "stencil_supplier","stencil_pr_no","date_received","stencil_validation_dt","stencil_revalidation_dt",
      "tension_a","tension_b","tension_c","tension_d","tension_e","received_by"];
    fields.forEach(f => {
      if (match[f]) {
        const el = document.querySelector(`[name="${f}"]`);
        if (el) el.value = match[f];
      }
    });
  }
}

document.querySelector('[name="stencil_no"]').addEventListener('blur', tryFetchStencilData);
document.querySelector('[name="side"]').addEventListener('blur', tryFetchStencilData);
</script>
